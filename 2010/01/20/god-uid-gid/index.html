<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Setting uid on God processes | dm&#39;s blog</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="I spent some minutes today at work figuring out why a script we use for files and assets propagation wasn’t working when fired up under God, but it actually was working when run as its normal user.The">
<meta property="og:type" content="article">
<meta property="og:title" content="Setting uid on God processes">
<meta property="og:url" content="http://damog.net/blog/2010/01/20/god-uid-gid/index.html">
<meta property="og:site_name" content="dm's blog">
<meta property="og:description" content="I spent some minutes today at work figuring out why a script we use for files and assets propagation wasn’t working when fired up under God, but it actually was working when run as its normal user.The">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Setting uid on God processes">
<meta name="twitter:description" content="I spent some minutes today at work figuring out why a script we use for files and assets propagation wasn’t working when fired up under God, but it actually was working when run as its normal user.The">
  
    <link rel="alternative" href="/blog/atom.xml" title="dm&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/blog/favicon.png">
  
  <link rel="stylesheet" href="/blog/css/style.css" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>
<body>
  <div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/blog/">dm&#39;s blog</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">Home</a></li><li><a href="/blog/archives">Archives</a></li>
			<li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li>
			<li><a href="/blog/atom.xml" id="nav-rss-link" class="nav-icon" title="RSS Feed"></a></li>
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="q" value="site:http://damog.net/blog"></form>
	</div>
</header>
    <div id="main">
      <article id="post-god-uid-gid" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/blog/2010/01/20/god-uid-gid/" class="article-date">
  <time datetime="2010-01-20T14:36:32.000Z" itemprop="datePublished">Wed Jan 20, 2010</time>
</a>
		</span>
		<span class="meta-elements author">David Moreno</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 class="article-title entry-title" itemprop="name">
      Setting uid on God processes
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<p>I spent some minutes today at work figuring out why a script we use for files and assets propagation wasn’t working when fired up under <a href="http://god.rubyforge.org/" target="_blank" rel="external">God</a>, but it actually was working when run as its normal user.</p><br><p>The script is a <a href="http://www.sinatrarb.com" target="_blank" rel="external">Sinatra</a> application that, upon pings/requests, connects through SSH to different servers on our clusters and execute commands. Details on the implementation are irrelevant here. Since this is automatized, we use key files for the SSH authentication.</p><br><p>When the script was running as the regular user, everything was working fine, but it wasn’t under root. So I figured, <a href="http://net-ssh.rubyforge.org/ssh/v2/api/" target="_blank" rel="external">Net::SSH</a> was trying to use root’s private keys file. After reading God’s examples I found out that you can also set uid and gid on the watched processes, so that’s what I configured:</p>

<p><code lang="ruby"><br> w.uid = “myuser”<br> w.gid = “myuser”<br></code></p>
<p>However, this was still not working. So I made the script print some verification:</p>

<p><code lang="ruby"><br>puts “My uid is: #{Process.uid} and euid: #{Process.euid} and user: #{ENV[‘USER’]}”<br></code></p>
<p>So <tt>Process.uid</tt> and <tt>Process.euid</tt> was correctly printing the UID for &quot;myuser&quot;, but ENV[‘USER’] was still &quot;root&quot;. I figured that ENV[&quot;HOME&quot;] would be the home directory based on the user, &quot;/root&quot;, so maybe Net::SSH was still trying to read <tt>/root/.ssh/id_rsa</tt>, and it was, quoting Net::SSH’s :keys option:</p><br><blockquote><br><p><br><meta charset="utf-8"><br><table class="list" style="margin-top: 2em; margin-right: 2em; margin-bottom: 2em; margin-left: 2em; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: black; border-right-color: black; border-bottom-color: black; border-left-color: black; background-image: initial; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 221); padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; background-position: initial initial; background-repeat: initial initial; "><br>    <tbody><br>        <tr><br>            <td style="padding-top: 0.2em; padding-right: 0.2em; padding-bottom: 0.2em; padding-left: 0.2em; text-align: center; vertical-align: top; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: initial; "><code>:keys</code></td><br>            <td style="padding-top: 0.2em; padding-right: 0.2em; padding-bottom: 0.2em; padding-left: 0.2em; text-align: left; vertical-align: top; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: initial; ">This specifies the list of private key files to use&nbsp;<em>instead</em>&nbsp;of the defaults (<code>$HOME/.ssh/id_dsa</code>,&nbsp;<code>$HOME/.ssh2/id_dsa</code>,&nbsp;<code>$HOME/.ssh/id_rsa</code>, and&nbsp;<code>$HOME/.ssh2/id_rsa</code>). The value of this option should be an array of strings.</td><br>        </tr><br>    </tbody><br></table><br><br></p><br></blockquote><br><p>God correctly runs the process with the given uid/gid but it will not change your environment variables. And there’s nothing wrong with it, all generated processes on Unix systems will inherit its parent’s set of variables. God shouldn’t necessarily have to be different, but in case you mess around with a given user’s environment variables on a process watched by God, remember this post :-)</p>
    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/environment-variables/">environment variables</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/god/">god</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/processes/">processes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ruby/">ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ssh/">ssh</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/sysadmin/">sysadmin</a></li></ul>

			</span>
		</div>
	</footer>
	
    
<nav id="article-nav">
  
    <a href="/blog/2010/01/28/kindle-is-shit-next-to-ipad/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Why the Kindle is a piece of shit next to the iPad
        
      </div>
    </a>
  
  
    <a href="/blog/2010/01/19/plack/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          Plack
        
      </div>
    </a>
  
</nav>

  
</article>




    </div>
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:damog.net/blog">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/blog/">dm&#39;s blog</a>
	</h1>
	<span class="copyright">
		&copy; 2016 David Moreno<br>
		Modify from <a href="http://sanographix.github.io/tumblr/apollo/" target="_blank">Apollo</a> theme, designed by <a href="http://www.sanographix.net/" target="_blank">SANOGRAPHIX.NET</a><br>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js" type="text/javascript"></script>
  </div>
</body>
</html>